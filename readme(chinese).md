# PCG蓝图类解释文档

PCG现完成的内容总共有两个类（Blueprint Class），一个是环境类（PCG_Environment_Spline），另一个则是道路类（PCG_Road_Spline）。
环境类会在拖入Editor之后会自带Spline，用户在选择了想要生成的环境物体（Static Mesh）后，物体会随Spline生成，可以通过添加和拖拽Spline Point来塑造出想要的环境形状。
道路类和环境类是相同的，但少了一些功能，在具体解释中会提到。

当前PCG的研发阶段是在尝试实现环境规避道路的规则。

PCG现有两个文件夹，一个是旧版本，另一个是现版本。可在工程的Content/PCGTool中找到

两个版本的唯一的区别是怎么实现环境避让道路规则。
	旧版本是用的暴力方法将和道路有碰撞的环境物体全部invisible。旧版本是能够正常运行的
	现版本则是通过道路和环境的碰撞点，找出在环境的Spline上面不能再继续使用的线段后，重新生成环境。现版本基本框架和思路都以完成，但有不少Bug没有解决导致不能正常运行。

具体解释：
	环境类（PCG_Environment_Spline）
		环境物体生成逻辑是在Spline上的当前位置放下物体后，计算出下一个可用的位置，然后放下下一个物体，循环往复直到Spline上没有可用位置。反映在Spline上就是通过Spline的Distance大小确定位置。
		
		Auto Spacing模式是程序会通过用户选择的物体的大小得到能够让两个物体能够正好相连的距离。但实际实现则因为Spline Mesh Component必须提供物体生成的起始点和终点的性质，并没有完全按照之前提到的逻辑完成。该模式不能对生成的环境物体进行旋转和缩放。该模式用户当前只能选择一个物体去生成。
		
		非Auto Spacing模式是根据用户自己输入的间隔距离，或是用户选择的值区间中随机生成的间隔距离，来生成的接下来的可用位置。因为实现方式不一样（用的是Spawn Static Mesh），该模式让用户可以对每个生成的Mesh添加统一或是随机的旋转和缩放。该模式用户选择多个物体去生成。
		
	道路类（PCG_Road_Spline）
		道路生成逻辑和环境类是一致的。不过只有Auto Spacing模式，没有其他选择。

	环境规避道路规则（旧版本）
		思路是将和道路有重叠的环境Mesh直接隐藏。
		
		道路类生成的道路是一个个Spline Mesh连接而成，因此规则实现的方式是记录下所有生成的Spline Mesh Component，遍历这些Mesh时用每一个Mesh去做component overlap components方法来检测是否与环境类的Mesh有overlap，若有则将这个环境类的Mesh设成invisible，并将环境类Mesh记录下来。当每次重新生成道路类时，若曾有更改过的环境类Mesh，则将其还原。

		但该方法会导致道路和剩下环境类生成的物体会有很明显的空缺部分

	环境规避道路规则（新版本）
		思路是将和道路有重叠的环境Mesh挪到道路的边缘，解决旧版本的空缺问题

		实现方式：
			记录下所有生成的Spline Mesh Component，遍历这些Mesh时，找出Mesh的两条边界（举例：道路Mesh为长方形，道路朝向是长方形的短边，两条边界则是长方形两条长边），通过multi line trace找出所有会与其碰撞的环境物体，记录下每个环境类和其对应产生的碰撞点在该环境类上的Spline位置（记录Distance数据）。
			
			然后遍历得到的环境类，将其对应的碰撞点通过Distance数据从小到大排列，接着遍历所有碰撞点，检测当前碰撞点和下一个碰撞点所组成的Spline线段是否还是可用线段。检测方法则是取当前线段的中间点和它的Up Vector，用line trace朝Up Vector去检测其是否和道路物体有碰撞。有则该线段为不可用线段，反之该线段依然可用。当完成所有碰撞点检测之后，则对当前环境类的可用线段数据进行更新。最后在让当前环境类重新生成环境物体。

		该方法目前已完成搭建，但仍有许多Bug导致其未能正常运行。

		Bug:
			前提：在环境类完成初始生成，拖动位置之后。（并未测试过初始位置情况）
				1. 道路与其碰撞后重新生成的环境会回到初始生成位置。
				
				2. 用中间点检测法时生成的line的位置并不在该有的位置，会出现在初始生成位置。

				3. 重新生成的环境并未看到明显为道路预留的位置，即更新的可用线段可能失败

		可能导致Bug的原因：
			适用于1，2，3：
				Attach Component to Component的使用有问题。所有PCG生成的物体都不能在编辑器的显示列表中找到。虽然可以在场景中强行选择单个环境物体，但都没有Details面板。	这也可能导致环境类没有实时更新Spline的位置。

			适用于3：
				Structure的错误使用。蓝图不能直接生成nested array变量（数组存数组）。网上学到的方法则是可以用自建的structure来存一个数组，然后再在蓝图中生成一个该structure 的数组。道路类的使用方法是创建了一个Map变量，其中key是环境类，而value则是自建的structure（其中是Float Map，存储的是不可用线段信息，key是起始点，value是终止点）。先前的简单检测发现该变量中structure的数组为空，可能出现了空指代的情况。但也可能是因为前一个原因导致完全没有不可用线段而没有做过添加操作。




